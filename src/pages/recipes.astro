---
import { getCollection } from 'astro:content';
import { getImage } from 'astro:assets';
import BaseLayout from '../layouts/BaseLayout.astro';
import Header from '../components/Header.astro';
import RecipesClient from '../components/RecipesClient';

const allRecipes = await getCollection('recipes');

// Prepare recipes data for the client component
const recipesData = await Promise.all(allRecipes.map(async (recipe) => {
  let imageSrc = null;

  if (recipe.data.image) {
    // For custom recipes or recipes with local images
    if (recipe.slug.includes('custom-recipes')) {
      imageSrc = `/recipes/${recipe.slug.split('/')[1]}/${recipe.data.image.src.split('/').pop()}`;
    } else {
      // For regular recipes
      imageSrc = `/recipes/${recipe.slug}/${recipe.data.image.src.split('/').pop()}`;
    }
  }

  return {
    id: recipe.id,
    title: recipe.data.title,
    tags: recipe.data.tags || [],
    source: recipe.data.source,
    notes: recipe.data.notes,
    type: recipe.data.type,
    slug: recipe.slug.includes('custom-recipes') ? `/custom-recipes/${recipe.slug.split('/')[1]}` : null,
    image: imageSrc,
  };
}));

const keywords = ['karlo delalic', 'portfolio', 'distributed systems', 'software engineer', 'recipes'];
---

<BaseLayout title="Recipes" keywords={keywords}>
  <Header slot="header" />
  <RecipesClient client:load recipes={recipesData} />
</BaseLayout>
